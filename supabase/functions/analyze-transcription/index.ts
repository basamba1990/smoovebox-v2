// supabase/functions/analyze-transcription/index.js
import { createClient } from 'npm:@supabase/supabase-js@2.39.3'
import OpenAI from 'npm:openai@4.28.0'

const VIDEO_STATUS = {
  UPLOADED: 'uploaded',
  PROCESSING: 'processing',
  TRANSCRIBED: 'transcribed',
  ANALYZING: 'analyzing',
  ANALYZED: 'analyzed',
  PUBLISHED: 'published',
  FAILED: 'failed'
};

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'POST, OPTIONS'
};

// ‚úÖ PROMPTS MULTILINGUES POUR L'ANALYSE
const ANALYSIS_PROMPTS = {
  fr: `
En tant qu'expert en communication, analysez cette transcription vid√©o en fran√ßais.

Transcription: {text}

Fournissez une analyse structur√©e en JSON avec le format suivant:
{
  "summary": "r√©sum√© en 2-3 phrases",
  "key_topics": ["th√®me1", "th√®me2", "th√®me3"],
  "sentiment": "positif/neutre/n√©gatif",
  "sentiment_score": 0.8,
  "communication_advice": ["conseil1", "conseil2"],
  "tone_analysis": {
    "emotion": "enthousiaste/calme/energique",
    "pace": "rapide/moder√©/lent",
    "clarity": "excellente/bonne/moyenne/faible"
  }
}

R√©pondez UNIQUEMENT avec le JSON, sans texte suppl√©mentaire.
  `,
  en: `
As a communication expert, analyze this video transcription in English.

Transcription: {text}

Provide a structured analysis in JSON with the following format:
{
  "summary": "summary in 2-3 sentences",
  "key_topics": ["topic1", "topic2", "topic3"],
  "sentiment": "positive/neutral/negative",
  "sentiment_score": 0.8,
  "communication_advice": ["advice1", "advice2"],
  "tone_analysis": {
    "emotion": "enthusiastic/calm/energetic",
    "pace": "fast/moderate/slow",
    "clarity": "excellent/good/average/poor"
  }
}

Respond ONLY with the JSON, without any additional text.
  `,
  es: `
Como experto en comunicaci√≥n, analiza esta transcripci√≥n de video en espa√±ol.

Transcripci√≥n: {text}

Proporciona un an√°lisis estructurado en JSON con el siguiente formato:
{
  "summary": "resumen en 2-3 frases",
  "key_topics": ["tema1", "tema2", "tema3"],
  "sentiment": "positivo/neutral/negativo",
  "sentiment_score": 0.8,
  "communication_advice": ["consejo1", "consejo2"],
  "tone_analysis": {
    "emotion": "entusiasta/calmo/energ√©tico",
    "pace": "r√°pido/moderado/lento",
    "clarity": "excelente/buena/promedio/mala"
  }
}

Responde √öNICAMENTE con el JSON, sin texto adicional.
  `,
  de: `
Als Kommunikationsexperte analysieren Sie diese Video-Transkription auf Deutsch.

Transkript: {text}

Geben Sie eine strukturierte Analyse im JSON-Format mit folgendem Format an:
{
  "summary": "Zusammenfassung in 2-3 S√§tzen",
  "key_topics": ["Thema1", "Thema2", "Thema3"],
  "sentiment": "positiv/neutral/negativ",
  "sentiment_score": 0.8,
  "communication_advice": ["Ratschlag1", "Ratschlag2"],
  "tone_analysis": {
    "emotion": "begeistert/ruhig/energisch",
    "pace": "schnell/moderat/langsam",
    "clarity": "ausgezeichnet/gut/durchschnittlich/schlecht"
  }
}

Antworten Sie NUR mit dem JSON, ohne zus√§tzlichen Text.
  `,
  it: `
Come esperto di comunicazione, analizza questa trascrizione video in italiano.

Trascrizione: {text}

Fornisci un'analisi strutturata in JSON con il seguente formato:
{
  "summary": "riassunto in 2-3 frasi",
  "key_topics": ["tema1", "tema2", "tema3"],
  "sentiment": "positivo/neutro/negativo",
  "sentiment_score": 0.8,
  "communication_advice": ["consiglio1", "consiglio2"],
  "tone_analysis": {
    "emotion": "entusiasta/calmo/energico",
    "pace": "veloce/moderato/lento",
    "clarity": "eccellente/buona/media/scarsa"
  }
}

Rispondi SOLO con il JSON, senza testo aggiuntivo.
  `,
  pt: `
Como especialista em comunica√ß√£o, analise esta transcri√ß√£o de v√≠deo em portugu√™s.

Transcri√ß√£o: {text}

Forne√ßa uma an√°lise estruturada em JSON com o seguinte formato:
{
  "summary": "resumo em 2-3 frases",
  "key_topics": ["tema1", "tema2", "tema3"],
  "sentiment": "positivo/neutro/negativo",
  "sentiment_score": 0.8,
  "communication_advice": ["conselho1", "conselho2"],
  "tone_analysis": {
    "emotion": "entusi√°stico/calmo/energ√©tico",
    "pace": "r√°pido/moderado/lento",
    "clarity": "excelente/boa/m√©dia/fraca"
  }
}

Responda APENAS com o JSON, sem texto adicional.
  `,
  ru: `
–ö–∞–∫ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è–º, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —ç—Ç—É —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É –≤–∏–¥–µ–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è: {text}

–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
  "summary": "—Ä–µ–∑—é–º–µ –≤ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö",
  "key_topics": ["—Ç–µ–º–∞1", "—Ç–µ–º–∞2", "—Ç–µ–º–∞3"],
  "sentiment": "–ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π/–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π/–Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π",
  "sentiment_score": 0.8,
  "communication_advice": ["—Å–æ–≤–µ—Ç1", "—Å–æ–≤–µ—Ç2"],
  "tone_analysis": {
    "emotion": "–≤–æ—Å—Ç–æ—Ä–∂–µ–Ω–Ω—ã–π/—Å–ø–æ–∫–æ–π–Ω—ã–π/—ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π",
    "pace": "–±—ã—Å—Ç—Ä—ã–π/—É–º–µ—Ä–µ–Ω–Ω—ã–π/–º–µ–¥–ª–µ–Ω–Ω—ã–π",
    "clarity": "–æ—Ç–ª–∏—á–Ω–∞—è/—Ö–æ—Ä–æ—à–∞—è/—Å—Ä–µ–¥–Ω—è—è/–ø–ª–æ—Ö–∞—è"
  }
}

–û—Ç–≤–µ—á–∞–π—Ç–µ –¢–û–õ–¨–ö–û JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
  `,
  zh: `
‰Ωú‰∏∫Ê≤üÈÄö‰∏ìÂÆ∂ÔºåËØ∑Áî®‰∏≠ÊñáÂàÜÊûêÊ≠§ËßÜÈ¢ëËΩ¨ÂΩï„ÄÇ

ËΩ¨ÂΩïÔºö{text}

‰ª•JSONÊ†ºÂºèÊèê‰æõÁªìÊûÑÂåñÂàÜÊûêÔºö
{
  "summary": "2-3Âè•ËØùÊÄªÁªì",
  "key_topics": ["‰∏ªÈ¢ò1", "‰∏ªÈ¢ò2", "‰∏ªÈ¢ò3"],
  "sentiment": "ÁßØÊûÅ/‰∏≠ÊÄß/Ê∂àÊûÅ",
  "sentiment_score": 0.8,
  "communication_advice": ["Âª∫ËÆÆ1", "Âª∫ËÆÆ2"],
  "tone_analysis": {
    "emotion": "ÁÉ≠ÊÉÖ/ÂÜ∑Èùô/Á≤æÂäõÂÖÖÊ≤õ",
    "pace": "Âø´/‰∏≠/ÊÖ¢",
    "clarity": "‰ºòÁßÄ/Â•Ω/‰∏ÄËà¨/Â∑Æ"
  }
}

‰ªÖÁî®JSONÂõûÁ≠îÔºå‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïÂÖ∂‰ªñÊñáÊú¨„ÄÇ
  `,
  ja: `
„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥„ÅÆÂ∞ÇÈñÄÂÆ∂„Å®„Åó„Å¶„ÄÅ„Åì„ÅÆ„Éì„Éá„Ç™„ÅÆÊñáÂ≠óËµ∑„Åì„Åó„ÇíÊó•Êú¨Ë™û„ÅßÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

ÊñáÂ≠óËµ∑„Åì„Åó: {text}

‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅßÊßãÈÄ†Âåñ„Åï„Çå„ÅüÂàÜÊûê„ÇíJSON„ÅßÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
{
  "summary": "2„Äú3Êñá„ÅÆË¶ÅÁ¥Ñ",
  "key_topics": ["„Éà„Éî„ÉÉ„ÇØ1", "„Éà„Éî„ÉÉ„ÇØ2", "„Éà„Éî„ÉÉ„ÇØ3"],
  "sentiment": "„Éù„Ç∏„ÉÜ„Ç£„Éñ/„Éã„É•„Éº„Éà„É©„É´/„Éç„Ç¨„ÉÜ„Ç£„Éñ",
  "sentiment_score": 0.8,
  "communication_advice": ["„Ç¢„Éâ„Éê„Ç§„Çπ1", "„Ç¢„Éâ„Éê„Ç§„Çπ2"],
  "tone_analysis": {
    "emotion": "ÁÜ±ÁãÇÁöÑ/ËêΩ„Å°ÁùÄ„ÅÑ„Åü/„Ç®„Éç„É´„ÇÆ„ÉÉ„Ç∑„É•",
    "pace": "ÈÄü„ÅÑ/‰∏≠Á®ãÂ∫¶/ÈÅÖ„ÅÑ",
    "clarity": "ÂÑ™ÁßÄ/ËâØ„ÅÑ/Âπ≥Âùá/ÊÇ™„ÅÑ"
  }
}

JSON„ÅÆ„Åø„ÅßÂøúÁ≠î„Åó„ÄÅËøΩÂä†„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅØÂê´„ÇÅ„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
  `,
  ko: `
Ïª§ÎÆ§ÎãàÏºÄÏù¥ÏÖò Ï†ÑÎ¨∏Í∞ÄÎ°úÏÑú Ïù¥ ÎπÑÎîîÏò§ Ìä∏ÎûúÏä§ÌÅ¨Î¶ΩÏÖòÏùÑ ÌïúÍµ≠Ïñ¥Î°ú Î∂ÑÏÑùÌïòÏÑ∏Ïöî.

Ìä∏ÎûúÏä§ÌÅ¨Î¶ΩÏÖò: {text}

Îã§Ïùå ÌòïÏãùÏúºÎ°ú Íµ¨Ï°∞ÌôîÎêú Î∂ÑÏÑùÏùÑ JSONÏúºÎ°ú Ï†úÍ≥µÌïòÏÑ∏Ïöî:
{
  "summary": "2-3Î¨∏Ïû• ÏöîÏïΩ",
  "key_topics": ["Ï£ºÏ†ú1", "Ï£ºÏ†ú2", "Ï£ºÏ†ú3"],
  "sentiment": "Í∏çÏ†ïÏ†Å/Ï§ëÎ¶ΩÏ†Å/Î∂ÄÏ†ïÏ†Å",
  "sentiment_score": 0.8,
  "communication_advice": ["Ï°∞Ïñ∏1", "Ï°∞Ïñ∏2"],
  "tone_analysis": {
    "emotion": "Ïó¥Ï†ïÏ†Å/Ï∞®Î∂ÑÌïú/ÏóêÎÑàÏ†úÌã±",
    "pace": "Îπ†Î¶Ñ/Î≥¥ÌÜµ/ÎäêÎ¶º",
    "clarity": "Ïö∞ÏàòÌï®/Ï¢ãÏùå/Î≥¥ÌÜµ/ÎÇòÏÅ®"
  }
}

JSONÏúºÎ°úÎßå ÏùëÎãµÌïòÍ≥† Ï∂îÍ∞Ä ÌÖçÏä§Ìä∏Î•º Ìè¨Ìï®ÌïòÏßÄ ÎßàÏÑ∏Ïöî.
  `
};

const SYSTEM_MESSAGES = {
  fr: "Vous √™tes un expert en analyse de communication. R√©pondez UNIQUEMENT en JSON valide, sans texte suppl√©mentaire.",
  en: "You are a communication analysis expert. Respond ONLY with valid JSON, without any additional text.",
  es: "Eres un experto en an√°lisis de comunicaci√≥n. Responde √öNICAMENTE en JSON v√°lido, sin texto adicional.",
  de: "Sie sind ein Experte f√ºr Kommunikationsanalyse. Antworten Sie NUR mit g√ºltigem JSON, ohne zus√§tzlichen Text.",
  it: "Sei un esperto di analisi della comunicazione. Rispondi SOLO con JSON valido, senza testo aggiuntivo.",
  pt: "Voc√™ √© um especialista em an√°lise de comunica√ß√£o. Responda APENAS com JSON v√°lido, sem texto adicional.",
  ru: "–í—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏. –û—Ç–≤–µ—á–∞–π—Ç–µ –¢–û–õ–¨–ö–û –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.",
  zh: "ÊÇ®ÊòØÊ≤üÈÄöÂàÜÊûê‰∏ìÂÆ∂„ÄÇ‰ªÖÁî®ÊúâÊïàÁöÑJSONÂõûÁ≠îÔºå‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïÂÖ∂‰ªñÊñáÊú¨„ÄÇ",
  ja: "„ÅÇ„Å™„Åü„ÅØ„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥ÂàÜÊûê„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇÊúâÂäπ„Å™JSON„ÅÆ„Åø„ÅßÂøúÁ≠î„Åó„ÄÅËøΩÂä†„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅØÂê´„ÇÅ„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ",
  ko: "ÎãπÏã†ÏùÄ Ïª§ÎÆ§ÎãàÏºÄÏù¥ÏÖò Î∂ÑÏÑù Ï†ÑÎ¨∏Í∞ÄÏûÖÎãàÎã§. Ïú†Ìö®Ìïú JSONÏúºÎ°úÎßå ÏùëÎãµÌïòÍ≥† Ï∂îÍ∞Ä ÌÖçÏä§Ìä∏Î•º Ìè¨Ìï®ÌïòÏßÄ ÎßàÏÑ∏Ïöî."
};

// ‚úÖ LANGUAGES SUPPORTED FOR ANALYSIS
const SUPPORTED_ANALYSIS_LANGUAGES = {
  'fr': 'French',
  'en': 'English', 
  'es': 'Spanish',
  'de': 'German',
  'it': 'Italian',
  'pt': 'Portuguese',
  'ru': 'Russian',
  'zh': 'Chinese',
  'ja': 'Japanese',
  'ko': 'Korean'
};

Deno.serve(async (req) => {
  console.log("üîç Fonction analyze-transcription (multilingue) appel√©e");

  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  let videoId = null;

  try {
    let requestBody;
    try {
      requestBody = await req.json();
      console.log("üì¶ Corps re√ßu:", { 
        videoId: requestBody.videoId,
        transcriptionLength: requestBody.transcriptionText?.length,
        userId: requestBody.userId,
        transcriptionLanguage: requestBody.transcriptionLanguage
      });
    } catch (parseError) {
      console.error("‚ùå Erreur parsing JSON:", parseError);
      return new Response(
        JSON.stringify({ 
          error: 'Corps de requ√™te JSON invalide',
          details: parseError.message 
        }),
        { 
          status: 400, 
          headers: { ...corsHeaders, 'Content-Type': 'application/json' } 
        }
      );
    }

    const { videoId: vidId, transcriptionText, userId, transcriptionLanguage } = requestBody;
    videoId = vidId;

    if (!videoId) {
      console.error("‚ùå videoId manquant");
      return new Response(
        JSON.stringify({ error: 'Param√®tre videoId requis' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    let textToAnalyze = transcriptionText;
    if (!textToAnalyze) {
      console.log("üìÑ Fetch transcription depuis DB...");
      const supabaseUrl = Deno.env.get('SUPABASE_URL');
      const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
      const supabase = createClient(supabaseUrl, supabaseServiceKey);
      const { data: video } = await supabase
        .from('videos')
        .select('transcription_text, transcription_language')
        .eq('id', videoId)
        .single();
      textToAnalyze = video?.transcription_text;
    }

    if (!textToAnalyze?.trim()) {
      console.error("‚ùå transcriptionText manquant");
      return new Response(
        JSON.stringify({ error: 'Param√®tre transcriptionText requis' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const supabaseUrl = Deno.env.get('SUPABASE_URL');
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
    const openaiApiKey = Deno.env.get('OPENAI_API_KEY');

    if (!supabaseUrl || !supabaseServiceKey) {
      throw new Error('Configuration Supabase manquante');
    }

    if (!openaiApiKey) {
      throw new Error('Cl√© API OpenAI manquante');
    }

    const supabase = createClient(supabaseUrl, supabaseServiceKey);
    const openai = new OpenAI({ apiKey: openaiApiKey });

    // V√©rification que la vid√©o existe
    console.log(`üîç Recherche vid√©o: ${videoId}`);
    const { data: video, error: videoError } = await supabase
      .from('videos')
      .select('*')
      .eq('id', videoId)
      .single();

    if (videoError) {
      console.error("‚ùå Erreur recherche vid√©o:", videoError);
      throw new Error(`Vid√©o non trouv√©e: ${videoError.message}`);
    }

    console.log("‚úÖ Vid√©o trouv√©e, mise √† jour statut ANALYZING");

    // Mettre √† jour le statut
    const { error: updateError } = await supabase
      .from('videos')
      .update({ 
        status: VIDEO_STATUS.ANALYZING,
        updated_at: new Date().toISOString()
      })
      .eq('id', videoId);

    if (updateError) {
      console.error("‚ùå Erreur mise √† jour statut:", updateError);
      throw new Error(`Erreur mise √† jour statut: ${updateError.message}`);
    }

    console.log(`üîç D√©but analyse pour video ${videoId}, longueur texte: ${textToAnalyze.length}`);

    // ‚úÖ ANALYSE MULTILINGUE
    const analysisLanguage = transcriptionLanguage || video?.transcription_language || 'fr';
    const systemMessage = SYSTEM_MESSAGES[analysisLanguage] || SYSTEM_MESSAGES['en'];
    const analysisPromptTemplate = ANALYSIS_PROMPTS[analysisLanguage] || ANALYSIS_PROMPTS['en'];
    
    const analysisPrompt = analysisPromptTemplate.replace('{text}', textToAnalyze.substring(0, 8000));

    console.log(`ü§ñ Appel OpenAI en ${analysisLanguage} (${SUPPORTED_ANALYSIS_LANGUAGES[analysisLanguage] || 'Unknown'})...`);
    
    const completion = await openai.chat.completions.create({
      model: "gpt-3.5-turbo",
      messages: [
        {
          role: "system",
          content: systemMessage
        },
        {
          role: "user",
          content: analysisPrompt
        }
      ],
      max_tokens: 1500,
      temperature: 0.3,
      response_format: { type: "json_object" }
    });

    console.log("‚úÖ R√©ponse OpenAI re√ßue");

    const analysisText = completion.choices[0].message.content;
    console.log("üìÑ R√©ponse OpenAI:", analysisText.substring(0, 200) + "...");

    let analysisResult;
    try {
      analysisResult = JSON.parse(analysisText);
      console.log("‚úÖ Analyse JSON pars√©e avec succ√®s");
    } catch (parseError) {
      console.error("‚ùå Erreur parsing JSON, utilisation fallback:", parseError);
      analysisResult = createBasicAnalysis(textToAnalyze, analysisLanguage);
    }

    // Ajouter la langue d'analyse aux r√©sultats
    analysisResult.analysis_language = analysisLanguage;
    analysisResult.analysis_language_name = SUPPORTED_ANALYSIS_LANGUAGES[analysisLanguage] || 'Unknown';

    // Calculer le score IA
    const aiScore = calculateAIScore(analysisResult);
    console.log(`üìä Score IA calcul√©: ${aiScore}`);

    // Extraire les insights de matching
    console.log("üîç Extraction des insights de matching...");
    const matchingInsights = await extractMatchingInsights(analysisResult, textToAnalyze, analysisLanguage);
    console.log("‚úÖ Insights de matching extraits:", matchingInsights);

    // V√âRIFIER SI LA COLONNE EXISTE AVANT DE METTRE √Ä JOUR
    console.log("üîç V√©rification de l'existence des colonnes...");
    
    // D'abord, essayer avec matching_insights
    let updatePayload = {
      status: VIDEO_STATUS.ANALYZED,
      analysis: analysisResult,
      ai_score: aiScore,
      updated_at: new Date().toISOString(),
      analysis_language: analysisLanguage
    };

    try {
      // Tenter d'ajouter matching_insights seulement si la colonne existe
      const testUpdate = await supabase
        .from('videos')
        .update({ ...updatePayload, matching_insights: matchingInsights })
        .eq('id', videoId);

      if (testUpdate.error) {
        console.log("‚ö†Ô∏è Colonne matching_insights non disponible, mise √† jour sans cette colonne");
        // R√©essayer sans matching_insights
        const { error: finalUpdateError } = await supabase
          .from('videos')
          .update(updatePayload)
          .eq('id', videoId);

        if (finalUpdateError) throw finalUpdateError;
      }
    } catch (updateError) {
      console.error("‚ùå Erreur sauvegarde analyse:", updateError);
      // Continuer m√™me si matching_insights √©choue
      const { error: basicUpdateError } = await supabase
        .from('videos')
        .update(updatePayload)
        .eq('id', videoId);
      
      if (basicUpdateError) throw basicUpdateError;
    }

    console.log("üéâ Analyse multilingue termin√©e avec succ√®s");

    return new Response(
      JSON.stringify({ 
        success: true, 
        message: 'Analyse multilingue termin√©e avec succ√®s',
        videoId: videoId,
        aiScore: aiScore,
        matchingInsights: matchingInsights,
        analysisLanguage: analysisLanguage,
        analysisLanguageName: SUPPORTED_ANALYSIS_LANGUAGES[analysisLanguage] || 'Unknown'
      }),
      { 
        status: 200, 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' } 
      }
    );

  } catch (error) {
    console.error("üí• Erreur g√©n√©rale dans analyze-transcription:", error);

    if (videoId) {
      try {
        const supabaseUrl = Deno.env.get('SUPABASE_URL');
        const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
        
        if (supabaseUrl && supabaseServiceKey) {
          const supabase = createClient(supabaseUrl, supabaseServiceKey);
          await supabase
            .from('videos')
            .update({ 
              status: VIDEO_STATUS.FAILED,
              error_message: error.message,
              updated_at: new Date().toISOString()
            })
            .eq('id', videoId);
          console.log("üìù Statut erreur sauvegard√©");
        }
      } catch (updateError) {
        console.error("‚ùå Erreur sauvegarde statut erreur:", updateError);
      }
    }

    return new Response(
      JSON.stringify({ 
        error: 'Erreur lors de l\'analyse multilingue', 
        details: error.message,
        stack: error.stack,
        supportedLanguages: Object.keys(SUPPORTED_ANALYSIS_LANGUAGES)
      }),
      { 
        status: 500, 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' } 
      }
    );
  }
});

// FONCTION POUR EXTRAIRE LES INSIGHTS DE MATCHING (MULTILINGUE)
async function extractMatchingInsights(analysis, transcription, language = 'fr') {
  
  // ‚úÖ DICTIONNAIRE MULTILINGUE POUR LES STYLES D'APPRENTISSAGE
  const LEARNING_STYLES = {
    fr: {
      pratique: 'pratique',
      r√©flexif: 'r√©flexif',
      √©quilibr√©: '√©quilibr√©'
    },
    en: {
      pratique: 'practical',
      r√©flexif: 'reflective', 
      √©quilibr√©: 'balanced'
    },
    es: {
      pratique: 'pr√°ctico',
      r√©flexif: 'reflexivo',
      √©quilibr√©: 'equilibrado'
    },
    de: {
      pratique: 'praktisch',
      r√©flexif: 'reflektierend',
      √©quilibr√©: 'ausgeglichen'
    }
  };

  const learningStyleMap = LEARNING_STYLES[language] || LEARNING_STYLES.fr;

  return {
    communication_style: analysis.tone_analysis?.emotion || 'neutre',
    expertise_areas: analysis.key_topics || [],
    sentiment_profile: analysis.sentiment,
    key_strengths: analysis.communication_advice || [],
    potential_mentor_topics: extractMentorTopics(analysis, transcription),
    learning_preferences: extractLearningStyle(analysis, language, learningStyleMap),
    analysis_language: language
  };
}

function extractMentorTopics(analysis, transcription) {
  const topics = analysis.key_topics || [];
  return topics.filter(topic => 
    transcription.toLowerCase().includes(topic.toLowerCase()) &&
    topic.length > 5
  ).slice(0, 3);
}

function extractLearningStyle(analysis, language = 'fr', styleMap = null) {
  const style = analysis.tone_analysis?.pace;
  
  if (!styleMap) {
    styleMap = {
      pratique: 'pratique',
      r√©flexif: 'r√©flexif', 
      √©quilibr√©: '√©quilibr√©'
    };
  }

  if (style === 'rapide' || style === 'fast' || style === 'r√°pido' || style === 'schnell') {
    return styleMap.pratique;
  }
  if (style === 'lent' || style === 'slow' || style === 'lento' || style === 'langsam') {
    return styleMap.r√©flexif;
  }
  return styleMap.√©quilibr√©;
}

function createBasicAnalysis(text, language = 'fr') {
  const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
  const sentenceCount = text.split(/[.!?]+/).length - 1;
  
  // ‚úÖ MESSAGES D'ANALYSE BASIQUE MULTILINGUES
  const BASIC_ANALYSIS_TEXTS = {
    fr: {
      summary: `Analyse basique: ${wordCount} mots, ${sentenceCount} phrases.`,
      topics: ["communication", "partage", "expression"],
      advice: [
        "Continuez √† pratiquer r√©guli√®rement",
        "Variez le d√©bit pour maintenir l'attention"
      ]
    },
    en: {
      summary: `Basic analysis: ${wordCount} words, ${sentenceCount} sentences.`,
      topics: ["communication", "sharing", "expression"],
      advice: [
        "Continue practicing regularly",
        "Vary your pace to maintain attention"
      ]
    },
    es: {
      summary: `An√°lisis b√°sico: ${wordCount} palabras, ${sentenceCount} frases.`,
      topics: ["comunicaci√≥n", "compartir", "expresi√≥n"],
      advice: [
        "Contin√∫a practicando regularmente",
        "Var√≠a tu ritmo para mantener la atenci√≥n"
      ]
    },
    de: {
      summary: `Grundlegende Analyse: ${wordCount} W√∂rter, ${sentenceCount} S√§tze.`,
      topics: ["Kommunikation", "Teilen", "Ausdruck"],
      advice: [
        "√úben Sie regelm√§√üig weiter",
        "Variieren Sie Ihr Tempo, um die Aufmerksamkeit aufrechtzuerhalten"
      ]
    }
  };

  const texts = BASIC_ANALYSIS_TEXTS[language] || BASIC_ANALYSIS_TEXTS.fr;

  return {
    summary: texts.summary,
    key_topics: texts.topics,
    sentiment: "neutre",
    sentiment_score: 0.5,
    communication_advice: texts.advice,
    tone_analysis: {
      emotion: "neutre",
      pace: "mod√©r√©",
      clarity: "bonne"
    },
    analysis_language: language
  };
}

function calculateAIScore(analysisResult) {
  let score = 7.0;
  if (analysisResult.summary && analysisResult.summary.length > 30) score += 0.5;
  if (analysisResult.key_topics && analysisResult.key_topics.length >= 2) score += 0.5;
  if (analysisResult.communication_advice && analysisResult.communication_advice.length > 0) score += 0.5;
  if (analysisResult.tone_analysis) score += 0.5;
  if (analysisResult.sentiment_score > 0.6) score += 0.5;
  return Math.min(Math.max(score, 0), 10.0);
}
